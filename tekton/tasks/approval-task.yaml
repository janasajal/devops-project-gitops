apiVersion: tekton.dev/v1
kind: Task
metadata:
  name: manual-approval
  namespace: tekton-pipelines
spec:
  params:
    - name: IMAGE_TAG
      type: string
    - name: TIMEOUT
      type: string
      default: "600"
  steps:
    - name: wait-for-approval
      image: bitnami/kubectl:latest
      script: |
        #!/bin/bash
        echo "================================================"
        echo "‚è∏Ô∏è  PRODUCTION DEPLOYMENT - MANUAL APPROVAL REQUIRED"
        echo "================================================"
        echo "üì¶ Image: janasajal/gitops-app:$(params.IMAGE_TAG)"
        echo "üåç Target: PRODUCTION namespace"
        echo ""
        echo "‚úÖ To APPROVE production deployment run:"
        echo "kubectl patch configmap pipeline-approval -n tekton-pipelines --type merge -p '{\"data\":{\"status\":\"approved\"}}'"
        echo ""
        echo "‚ùå To REJECT production deployment run:"
        echo "kubectl patch configmap pipeline-approval -n tekton-pipelines --type merge -p '{\"data\":{\"status\":\"rejected\"}}'"
        echo "================================================"

        # Reset to pending
        kubectl patch configmap pipeline-approval \
          -n tekton-pipelines \
          --type merge \
          -p '{"data":{"status":"pending"}}' 2>/dev/null || \
        kubectl create configmap pipeline-approval \
          -n tekton-pipelines \
          --from-literal=status=pending

        TIMEOUT=$(params.TIMEOUT)
        ELAPSED=0
        while [ $ELAPSED -lt $TIMEOUT ]; do
          STATUS=$(kubectl get configmap pipeline-approval \
            -n tekton-pipelines \
            -o jsonpath='{.data.status}')

          echo "‚è≥ Awaiting approval... [$STATUS] (${ELAPSED}s / ${TIMEOUT}s)"

          if [ "$STATUS" = "approved" ]; then
            echo "‚úÖ APPROVED! Deploying to production..."
            exit 0
          fi

          if [ "$STATUS" = "rejected" ]; then
            echo "‚ùå REJECTED! Production deployment cancelled."
            exit 1
          fi

          sleep 15
          ELAPSED=$((ELAPSED + 15))
        done

        echo "‚è∞ Timed out after ${TIMEOUT}s - deployment cancelled"
        exit 1
